# 윈도우 부팅 및 인증 절차

### 부팅

-> MBR 과 UEFI 부팅 절차 정확히 파악할 필요

NTOSKERNL.EXE 각각의 phase 순서대로 모듈이 초기화 된다. 

하드웨어 추상화 계층 -> 장치 드라이버 추상화 를 하여 윈도우가 하드웨어를 제어할 수 있도록 함

NT/XP와 Vista/7과는 phase0와 phase1에서 실행되는 단계가 조금씩 다르다

SMSS.exe 가 실행 세션 매니저 서브시스템

WINLOGON.exe 로그인 화면 표시(사용자 식별과 인증 - Graphical Indentification and Authentification) - 리눅스의 사용자 초기 화면 생각하면 됨

세션 0, 세션 1

-> 윈이닛은 시스템 프로세스를 먼저 올려주고, 윈로그온을 통해 사용자 세션을 실행시킨다

LSASS.EXE 보안에 관련한 처리 담당



### 윈도우 인증 방식

- LM(LAN Manager) -  
- NTLM v1 - 
- NTLM v2 -
- Kerberos - 비보안 네트워크에서 비밀키를 공유하는 네트워크 인증 프로토콜

윈로그온에서 GINA(사용자 식별과 인증) 모듈을 호출

-> 사용자가 ID/PW를 입력하면 LSA(Local Security Authority) 모듈을 호출

NTLM방식을 통해 hash값을 생성하면

SAM(Securtiy Account Manager)에 저장되어 있는 값과 비교

인증 확인 되면 SID(Security ID)를 발급하고 로그온이 가능

SRM(Security Reference Motior)은 커널 영역으로, 인증된 사용자에 대해 SID를 부여하고 SID기반 접근 제어 및 감사 메시지를 생성한다. 



# 윈도우 비밀번호 및 프로세스 분석

윈도우 사용자가 여러 명이 존재 가능하다. Volatility 혹은 PwDump를 이용해서 사용자 비밀번호를 획득 가능

- SAM 파일구조

username:sid:LM hash:NTLM hash::: 로 구성

win 7 이상은 NTLM 해쉬 값만 사용

> 획득한 패스워드는 Password Crack 사이트를 통해서 추출 가능
>
> **Password Crack의 원리**
>
> 패스워드로 사용되기 좋은 후보들을 구성하고, 전부 해시 함수로 돌려봐 결과값들을 미리 저장
>
> 동일한 해시값이 있다면 발견 완료. Dictionary Attack이라고도 함
>
> 그렇기 때문에 salt라고 하는 나만의 추가적인 정보를 넣어 놓는다. 
>
> Password Crack 사이트는 non-salt한 정보들에 한해서만 본래 값을 얻을 수 있는 것이다.



### 윈도우 프로세스

#### 프로그램과 프로세스의 차이

프로그램 : 어떤 작업을 위해서 실행 할 수 있는 파일

프로세스 : 메모리에 올라와 실행되고 있는 프로그램으로 운영체제로부터 시스템 자원을 할당 받는 작업 단위로 1개 이상의 스레드 소유 -> 휘발성

스레드 : 한 프로세스 내 동작하는 여러 실행흐름으로 프로세스 내 자원 공유

#### 프로세스 운영 모드

- 커널 모드  
  - 커널에서 관리하는 모든 자원에 접근 가능
  - 운영체제 코드(시스템 서비스, 디바이스 드라이버)는 커널모드에서 실행

- 유저 모드
  - 유저 애플리케이션은 유저모드에서만 실행 되어 커널 모드 안정성 확보
  - 커널 모드 권한 필요 시 시스템 서비스 호출을 하면 커널모드로 전환되어 코드 실행하고 유저 모드로 다시 전환 



# 상세 분석 절차

![image-20200614185802748](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20200614185802748.png)

포렌식의 상세 분석 절차는 크게 세 가지 영역을 분석하는 것으로 시작한다. 인터넷, 레지스트리, 파일의 영역이 이에 속하며 각 영역마다 단계를 걸쳐 분석을 진행한다. 각 영역의 종합적인 분석을 거치면 타임라인 분석을 진행한다.



## 1. 인터넷 분석

### 웹 아티팩트

#### 디지털 증거의 종류

- **보관 증거**

  사용자가 직접 작성한 데이터(사용자의 생각, 메일 내용 등)

- **생성 증거** 

  사용자의 개입없이 시스템에서 자동으로 생선된 증거, 이를 "아티팩트"라고 한다.(문서파일의 메타정보, 시스템 로그 등)

보관 증거는 사용자의 의도가 들어간 전문증거(전해들어져서 만들어진 정보)로 전문법칙 예외 규정(일상적인 기록 등)에 해당되는 경우에 한해 증거로 인정된다.

생성 증거인 아티팩트는 비진술 증거로 전문 법칙의 적용을 받지 않고 무결성, 신뢰성 등이 인정되는 경우 증거 능력 인정이 가능하다.

#### 주요 웹 아티팩트

1. 웹 히스토리
2. 웹 캐시
3. 웹 쿠키
4. 다운로드 목록



1) 웹 히스토리

사용자가 방문한 웹사이트 접속 

웹 히스토리 정보

- 방문 사이트  URL
- 방문 사이트 타이틀
- 방문 시간
- 방문 횟수

크롬은 데이터베이스 형태로 이러한 기록을 저장하고 있다.

keyword_search_terms를 통해 어떠한 키워드를 검색했는 지 파악 가능



2) 웹 캐시 

웹 서버 접속 시, 데이터를 다운로드 후 저장하여 재접속을 빠르게 처리

웹 캐시 정보

- Cache 데이터 : 다운로드 데이터
- Cache 인덱스 : 다운로드 URL, 다운로드 시간, Cache 데이터 위치

3) 웹 쿠키

웹사이트에서 사용자의 디스크/메모리에 저장하는 클라이언트 식별 데이터

사용자별로 개인화된 서비스 또는 인증 유지를 위해 사용

웹 쿠키 정보

- 호스트, 도메인, 경로

  >  [호스트].[도메인]/[경로] 형식으로 portal.cau.ac.kr/mail이면 portal이 호스트

- 쿠키 만료시간

- 이름, 값

4) 다운로드 목록

사용자가 의도적으로 선택해서 컴퓨터로 다운로드 받은 파일에 대한 정보

다운로드 목록 정보

- 다운로드 파일 URL
- 다운로드 파일의 로컬 저장 경로
- 파일 크기
- 다운로드 시간
- 다운로드 성공 여부



사용자자가 웹 아티팩트 정보를 지웠다하더라도 웹 로그 파일을 통해서 확인 가능하다.

![image-20200614181049626](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20200614181049626.png)



## 2. 레지스트리 분석

시스템 사용 흔적 분석 - > 응용프로그램 흔적 분석, 시스템 활동 분석, 사용자 활동 분석의 과정으로 진행된다.

### 레지스트리

윈도우 운영체제와 응용프로그램 구동에 필요한 정보를 저장하는 **계층형 데이터베이스**

부팅 과정부터 로그인, 서비스 실행, 응용프로그램 실행, 사용자 행위 등 윈도우 운영체제의 거의 모든 활동에 관여

윈도우 시스템 분석의 필수 요소

- 운영체제정보, 사용자 계정 정보, 시스템 정보, 응용프로그램 실행 흔적, 최근 접근 문서, 자동 실행 항목 등
- 원격 접속 흔적, 네트워크 드라이브 연결 흔적, 저장 매체 사용 흔적 등의 정보를 이용하여 추가적인 조사 대상 확인

**레지스트리 구성** 

키와 값으로 구성, 값은 이름, 종류, 데이터 속성을 보유하고 있다.

![image-20200614192508458](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20200614192508458.png)

 

### 하이브(Hive) 파일

레지스트리를 저장하고 있는 물리적인 파일 

활성시스템 커널에서 관리하여 파일에 대한 직접 접근은 불가(regedit.exe)

![image-20200614191404501](C:\Users\user\AppData\Roaming\Typora\typora-user-images\image-20200614191404501.png)

## 레지스트리 분석

#### 시스템 사용 흔적 분석

- 기본 시스템 정보, 시스템 마지막 종료 시각 
- USB 장치 연결 정보, 연결된 저장장치 정보
- 네트워크 정보, 공유 정보, 외부 시스템 연결 정보

#### 응용프로그램 사용 흔적 분석

- 응용프로그램 사용 로그

- 응용프로그램별 사용 흔적

#### 시스템 활동 분석

- 윈도우 검색 정보

- 최근에 열어본 파일, 최근 실행 명령

#### 사용자 활동 분석

- 시스템 사용자 프로필 목록
- 사용자별 기본 경로



